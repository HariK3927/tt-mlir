# This file downloads packages and create CMakeLists.txt file that contains
# corresponding paths such that external projects can readily integrate
# tt-mlir project either using include or add_subdirectory. In addition,
# [project_name]-src and [project_name]-build provide common interface for
# external projects to include files and libraries. Lastly, add .clang-tidy
# at the CPM_SOURCE_CACHE to prevent lint check for external repositories.

set(TARGET_CMAKELIST_FILE $ENV{CPM_SOURCE_CACHE}/CMakeLists.txt)
FILE(WRITE ${TARGET_CMAKELIST_FILE}
  "# This file was auto-generated by camke/dependencies/CMakeLists.txt\n\n"
)

if (TTMLIR_ENABLE_STABLEHLO)
  set(STABLEHLO_VERSION "d40285ef3db0687e3f1e2bb0d716d748485a9739")
  set(SHARDY_VERSION "c8da53a9e0826d1dbb6947de306dce3034d0de83")

  ## StableHLO
  CPMAddPackage(
      NAME stablehlo
      GITHUB_REPOSITORY openxla/stablehlo
      GIT_TAG ${STABLEHLO_VERSION}
  )

  if(stablehlo_ADDED)
    FILE(APPEND ${TARGET_CMAKELIST_FILE}
      "set(STABLEHLO_BINARY_DIR \"${stablehlo_BINARY_DIR}\")\n"
      "set(STABLEHLO_SOURCE_DIR \"${stablehlo_SOURCE_DIR}\")\n"
      "set(STABLEHLO_BINARY_DIR \$\{STABLEHLO_BINARY_DIR\} PARENT_SCOPE)\n"
      "set(STABLEHLO_SOURCE_DIR \$\{STABLEHLO_SOURCE_DIR\} PARENT_SCOPE)\n"
    )
    FILE(CREATE_LINK ${stablehlo_SOURCE_DIR} $ENV{CPM_SOURCE_CACHE}/stablehlo-src SYMBOLIC)
    FILE(CREATE_LINK ${stablehlo_BINARY_DIR} $ENV{CPM_SOURCE_CACHE}/stablehlo-build SYMBOLIC)
  endif()

  ## Shardy
  CPMAddPackage(
      NAME shardy
      GITHUB_REPOSITORY openxla/shardy
      GIT_TAG ${SHARDY_VERSION}
      PATCHES ${PROJECT_SOURCE_DIR}/cmake/dependencies/shardy.patch
  )

  if(shardy_ADDED)
    FILE(APPEND ${TARGET_CMAKELIST_FILE}
      "set(SHARDY_BINARY_DIR \"${shardy_BINARY_DIR}\")\n"
      "set(SHARDY_SOURCE_DIR \"${shardy_SOURCE_DIR}\")\n"
      "set(SHARDY_BINARY_DIR \$\{SHARDY_BINARY_DIR\} PARENT_SCOPE)\n"
      "set(SHARDY_SOURCE_DIR \$\{SHARDY_SOURCE_DIR\} PARENT_SCOPE)\n"
    )
    FILE(CREATE_LINK ${shardy_SOURCE_DIR} $ENV{CPM_SOURCE_CACHE}/shardy-src SYMBOLIC)
    FILE(CREATE_LINK ${shardy_BINARY_DIR} $ENV{CPM_SOURCE_CACHE}/shardy-build SYMBOLIC)
  endif()

endif()

FILE(WRITE $ENV{CPM_SOURCE_CACHE}/.clang-tidy
  "Checks: '-*'\n"
)
